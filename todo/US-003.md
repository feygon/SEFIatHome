# US-003: EFTA URL Builder & Gap Resolution

**Status:** done
**Model:** sonnet
**Component:** 2 (Work Unit Generator)
**Depends On:** US-001, US-002
**Traces To:** FR-014, FR-015, FR-016, DR-011, DR-012

## Description

Implements the EFTA URL construction logic and the gap resolution algorithm inside `src/sefi/db/efta.py`. Given an EFTA number and its primary dataset, the module builds the canonical DOJ PDF URL and attempts to resolve the document through primary, N-1, and N+1 datasets before declaring it genuinely missing. A `ResolutionResult` dataclass captures the outcome of each resolution attempt.

## Files to Create / Modify

- `src/sefi/db/efta.py` — `build_url()` function, `resolve_efta()` function, `ResolutionResult` dataclass
- `tests/unit/test_efta.py` — unit tests for URL construction, gap resolution (found-in-primary, found-adjacent, genuinely-missing), and EFTA format validation

## Acceptance Criteria

- [ ] `build_url(efta_number=39186, dataset=9)` returns exactly `"https://www.justice.gov/epstein/files/DataSet%209/EFTA00039186.pdf"` (FR-014)
- [ ] Dataset numbers below 1 or above 12 are skipped silently during resolution (FR-016)
- [ ] Given an EFTA not in its primary dataset but found in dataset N+1, `resolve_efta()` returns `ResolutionResult(found=True, was_adjacent=True)` with the N+1 URL (FR-016)
- [ ] Given an EFTA not found in primary, N-1, or N+1, `resolve_efta()` returns `ResolutionResult(found=False, genuinely_missing=True)` (FR-016)
- [ ] `build_url()` zero-pads EFTA numbers to exactly 8 digits in the filename (DR-012)
- [ ] A Pydantic validator or equivalent rejects EFTA format strings that do not match `^EFTA\d{8}$` (DR-011)
- [ ] URL format validator rejects strings that do not match the pattern `https://www.justice.gov/epstein/files/DataSet%20{N}/EFTA{XXXXXXXX}.pdf` (DR-012)
- [ ] `resolve_efta()` uses `efta_dataset_mapping.json` (via ingest working table) to determine the correct primary dataset for any given EFTA number (FR-015)
- [ ] All functions include type annotations and docstrings (NFR-002, NFR-008)

## Notes

- The resolution algorithm tries datasets in the order: `[primary, primary-1, primary+1]`. Do not try N-2 or further.
- URL existence checks (`check_url_exists`) must be injectable/mockable for tests — do not hard-code HTTP calls. Pass a callable parameter or use dependency injection so unit tests can substitute a stub.
- In production, `check_url_exists` performs an HTTP HEAD request; in tests it uses a mock that returns True/False per a fixture dict.
- `ResolutionResult` fields: `found: bool`, `url: str | None`, `dataset: int | None`, `was_adjacent: bool`, `genuinely_missing: bool`.
- The URL pattern uses `%20` (URL-encoded space) between `DataSet` and `{N}` — not a literal space and not `+`. This must be exact.
