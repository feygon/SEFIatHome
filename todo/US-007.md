# US-007: Findings Store

**Status:** tested
**Model:** sonnet
**Component:** 5 (Findings Store)
**Depends On:** US-001
**Traces To:** FR-038, FR-039, FR-040, FR-041, DR-007, DR-008, DR-010, DR-011, EC-004

## Description

Implements the `FindingsStore` class in `src/sefi/store/findings.py`. On initialization, `FindingsStore` creates the `findings.db` schema (findings, citations, and required indexes) if it does not exist. The class exposes `store_finding`, `get_findings_for_document`, `export_findings` (JSON and CSV), and `get_coverage`. All findings exports include `"license": "CC0-1.0"` metadata per the public-domain ethical constraint.

## Files to Create / Modify

- `src/sefi/store/findings.py` — `FindingsStore` class, `Finding` Pydantic model, `CoverageStats` Pydantic model
- `tests/unit/test_findings_store.py` — CRUD tests, export format verification, coverage stats, CC0 license presence in exports

## Acceptance Criteria

- [ ] On `__init__`, `findings.db` is created with the `findings` and `citations` tables matching the schema in DR-007 and DR-008 exactly (FR-038, DR-007, DR-008)
- [ ] Both required indexes (`idx_findings_unit_type`, `idx_findings_status`) are created on init (DR-010)
- [ ] `idx_citations_efta` index is created on the citations table on init (DR-008)
- [ ] After `store_finding(finding)`, the finding is retrievable by `finding_id` with all fields intact across a simulated process restart (new `FindingsStore` pointed at the same file) (FR-038)
- [ ] `get_findings_for_document(efta_number)` returns exactly 3 findings when 3 findings citing that EFTA exist, and an empty list when none exist (FR-039)
- [ ] `export_findings("json", {})` returns valid JSON bytes parseable into a list of finding objects (FR-040)
- [ ] `export_findings("csv", {})` returns valid UTF-8 CSV bytes with a header row and one data row per accepted finding (FR-040)
- [ ] The JSON export includes a top-level `"license": "CC0-1.0"` field (EC-004)
- [ ] `get_coverage("verify_finding")` returns a `CoverageStats` with `units_completed`, `units_total`, and `percent` between 0.0 and 100.0 (FR-041)
- [ ] `status` values in `findings` table are constrained to `pending`, `accepted`, `disputed`, `quarantined` (DR-007)
- [ ] EFTA number strings stored in `citations.efta_number` are validated against `^EFTA\d{8}$`; invalid formats raise a `ValueError` before insert (DR-011)
- [ ] All SQL uses parameterized `?` placeholders (NFR-004)
- [ ] All methods include type annotations and docstrings (NFR-002, NFR-008)

## Notes

- `FindingsStore.__init__` accepts `db_path: Path`; for tests, pass `Path(":memory:")` or a temp-dir path.
- The `FOREIGN KEY (unit_id) REFERENCES work_units(unit_id)` in the schema implies a `work_units` table must also be created (or the FK pragma disabled for MVP). For MVP, create a minimal `work_units` stub table on init, or use `PRAGMA foreign_keys = OFF` with a code comment explaining why.
- `store_finding` should be idempotent: if `finding_id` already exists, return the existing row without error (supports POST /result idempotency from AC-003 resolution note).
- `CoverageStats` Pydantic model fields: `unit_type: str`, `units_completed: int`, `units_total: int`, `percent: float`.
- The `corrections` table from DR-009 is POST-MVP — do not create it in this story.
- `export_findings` JSON format: `{"license": "CC0-1.0", "findings": [...]}` where each item is a dict of the finding row.
