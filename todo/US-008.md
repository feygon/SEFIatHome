# US-008: Basic Validation Layer

**Status:** pending
**Model:** sonnet
**Component:** 4 (Validation Layer)
**Depends On:** US-001, US-004, US-007
**Traces To:** FR-031, FR-032, EC-001, EC-002, EC-007

## Description

Implements the `ValidationLayer` class in `src/sefi/validation/layer.py` with two MVP behaviors: basic provenance checking (verifying that cited EFTA numbers are present in the ingested exports) and result deduplication (rejecting submissions for unit_ids that already have an accepted finding). Also implements a PII Guardian stub covering SSN, phone number, and postal address regex patterns, which quarantines matching results before acceptance.

## Files to Create / Modify

- `src/sefi/validation/layer.py` — `ValidationLayer` class with `validate_result()`, `verify_provenance()`, `scan_for_pii()`, `check_deduplication()`
- `tests/unit/test_validation.py` — unit tests for provenance rejection, deduplication rejection, PII detection (SSN, phone, postal), clean-result acceptance

## Acceptance Criteria

- [ ] A result citing an EFTA number not present in any ingested export is rejected with `accepted=False` and a provenance error in the `errors` list (FR-031)
- [ ] A result citing a valid EFTA number (present in ingested data) passes the provenance check (FR-031)
- [ ] Submitting a result for a `unit_id` that already has an `accepted` finding returns `accepted=False` with a message referencing the existing `finding_id` (FR-032)
- [ ] A result containing a string matching the SSN pattern (`\d{3}-\d{2}-\d{4}`) is quarantined: `accepted=False`, `pii_detected=True` (EC-001)
- [ ] A result containing a US phone number pattern is quarantined: `accepted=False`, `pii_detected=True` (EC-001)
- [ ] A result containing a postal address pattern (street number + street name + city/state/zip) is quarantined: `accepted=False`, `pii_detected=True` (EC-001)
- [ ] A quarantined result is stored in `findings.db` with `status="quarantined"` and is NOT written with `status="accepted"` (EC-001)
- [ ] `scan_for_pii()` runs on ALL result outputs before any acceptance decision; it cannot be bypassed (EC-001)
- [ ] A clean result (valid EFTA, no duplicate, no PII) is accepted: `accepted=True`, `pii_detected=False` (FR-031)
- [ ] All methods include type annotations and docstrings (NFR-002, NFR-008)

## Notes

- `ValidationLayer.__init__` accepts a `DatabaseAdapter` (for provenance lookups) and a `FindingsStore` (for deduplication checks).
- `validate_result(result: ResultSubmission) -> ValidationResult` is the single entry point. It calls the three sub-checks in this order: (1) PII scan, (2) provenance check, (3) deduplication. If PII is detected, short-circuit and quarantine immediately without running further checks.
- `ValidationResult` fields: `accepted: bool`, `quorum_status: str` (MVP default: `"achieved"` for solo-worker), `pii_detected: bool`, `errors: list[str]`, `finding_id: str | None`.
- PII patterns for MVP (FR-031, EC-001):
  - SSN: `\b\d{3}-\d{2}-\d{4}\b`
  - US phone: `\b(\+1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b`
  - Postal address: `\b\d{1,5}\s+[A-Za-z0-9\s,.]+(?:Street|St|Avenue|Ave|Boulevard|Blvd|Road|Rd|Drive|Dr|Lane|Ln|Way|Court|Ct)\b`
- Full quorum validation (N-of-M agreement) is POST-MVP. For MVP, `quorum_status` is always `"achieved"` on the first accepted result.
- Provenance check: look up `cited_eftas` from the submission in the ingested `entities` or `efta_mapping` working table. If any EFTA is not found, reject.
- PII Guardian stub label: add a `# MVP STUB` comment on the PII patterns list and a docstring note saying full victim-name pattern list is deferred to OQ-004.
