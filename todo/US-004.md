# US-004: Database Adapter (JSON Methods)

**Status:** done
**Model:** sonnet
**Component:** 1 (Database Adapter)
**Depends On:** US-001, US-002
**Traces To:** FR-001, FR-002, FR-003, FR-004

## Description

Implements the `DatabaseAdapter` class in `src/sefi/db/adapter.py`, providing the high-level read interface over the ingested JSON working tables. The adapter wraps the ingest layer and exposes three named query methods — `get_known_entities`, `get_known_relationships`, and `get_persons_registry` — alongside the generic `load_json_export` ingestion entry point. All queries use parameterized SQL.

## Files to Create / Modify

- `src/sefi/db/adapter.py` — `DatabaseAdapter` class with all four MVP methods
- `tests/unit/test_adapter.py` — unit tests asserting record counts, return types, and field presence for each method

## Acceptance Criteria

- [ ] `load_json_export(file_path, table_name)` returns an integer equal to the number of records loaded from the file (FR-001)
- [ ] `get_known_entities()` returns a `list[dict]` with 524 records when the standard export is loaded; each dict contains at minimum `id`, `name`, `type`, and `aliases` fields (FR-002)
- [ ] `get_known_relationships()` returns a `list[dict]` with 2,096 records when the standard export is loaded (FR-003)
- [ ] `get_persons_registry()` returns a `list[dict]` with 1,614 records when the standard export is loaded (FR-004)
- [ ] All SQL queries use `?` parameterized placeholders; no f-strings or `.format()` calls appear in any SQL string (NFR-004)
- [ ] No ORM imports exist in `adapter.py` (NFR-004)
- [ ] All methods include type annotations and docstrings (NFR-002, NFR-008)
- [ ] Return types are `list[dict]` (not raw sqlite3 `Row` objects); field names come from column names or JSON keys (FR-002)

## Notes

- `DatabaseAdapter.__init__` accepts a `sqlite3.Connection` (or a path to a SQLite file) so tests can pass an in-memory connection without touching the filesystem.
- `load_json_export` delegates to `IngestManager` from US-002; `DatabaseAdapter` is the public API, `IngestManager` is the implementation detail.
- The three `get_*` methods are straightforward `SELECT * FROM <table>` queries against the working tables populated by `load_json_export`.
- Return value is a plain `list[dict]` — convert sqlite3 `Row` objects using `dict(row)` or `row_factory = sqlite3.Row`.
- Post-MVP methods (`paginated_query`, `get_efta_range`, `get_document_versions`, `get_redactions_for_document`) are out of scope for this story. Add `NotImplementedError` stubs with docstrings if the interface requires them.
