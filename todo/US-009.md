# US-009: Distribution API

**Status:** pending
**Model:** sonnet
**Component:** 3 (Distribution API)
**Depends On:** US-001, US-005, US-006, US-007, US-008
**Traces To:** FR-023, FR-024, FR-025, FR-026, AC-001, AC-002, AC-003, AC-004, AC-005

## Description

Implements the FastAPI application with all four MVP endpoints — `GET /work`, `POST /result`, `GET /status`, and `GET /health` — across `src/sefi/api/main.py`, `routes.py`, and `models.py`. When no units are available, `GET /work` returns HTTP 200 with `{"available": false}`. `POST /result` is idempotent: a duplicate submission for an already-accepted unit returns the existing `finding_id` with `accepted: true`.

## Files to Create / Modify

- `src/sefi/api/models.py` — Pydantic models: `WorkUnitResponse`, `ResultSubmission`, `AcceptanceResponse`, `StatusResponse`, `HealthResponse`
- `src/sefi/api/routes.py` — FastAPI router with all four endpoint handlers
- `src/sefi/api/main.py` — FastAPI app factory, dependency injection wiring (generator, validation layer, findings store)
- `tests/unit/test_api.py` — API contract tests using `httpx.AsyncClient` + FastAPI `TestClient`

## Acceptance Criteria

- [ ] `GET /work` returns HTTP 200 with a JSON body that passes `WorkUnitResponse` Pydantic validation when a unit is available (FR-023, AC-001)
- [ ] `GET /work` returns HTTP 200 with `{"available": false}` when no units are available (FR-023, AC-001)
- [ ] `POST /result` with a valid body returns HTTP 200 with `accepted`, `finding_id`, `quorum_status`, `pii_detected`, `next_unit_available` fields (FR-024, AC-003)
- [ ] `POST /result` with an invalid body returns HTTP 422 (FR-024)
- [ ] `POST /result` is idempotent: a duplicate submission for an already-accepted `unit_id` returns the existing `finding_id` with `accepted: true` (requirements resolution note)
- [ ] `GET /status` returns HTTP 200 with all fields from AC-004: `total_units_generated`, `total_units_assigned`, `total_units_completed`, `total_findings_accepted`, `total_findings_quarantined`, `coverage_by_type` (FR-025, AC-004)
- [ ] All integer fields in `GET /status` response are non-negative; `total_units_completed <= total_units_assigned <= total_units_generated` (AC-004)
- [ ] `GET /health` returns HTTP 200 within 500ms with `status: "ok"`, `version`, and `findings_db_reachable` fields (FR-026, AC-005)
- [ ] `GET /health` returns HTTP 200 even if `findings.db` is unreachable (`findings_db_reachable: false`) (AC-005)
- [ ] All API request/response bodies are Pydantic `BaseModel` subclasses; no raw dicts at API boundaries (NFR-003)
- [ ] All route handlers and models include type annotations and docstrings (NFR-002, NFR-008)

## Notes

- `main.py` should expose a `create_app() -> FastAPI` factory function so tests can instantiate the app with mock dependencies.
- Use FastAPI dependency injection (`Depends`) to inject `WorkUnitGenerator`, `ValidationLayer`, and `FindingsStore` into route handlers. This avoids global state and makes testing straightforward.
- `WorkUnitResponse` must mirror the full `WorkUnit` schema from AC-001, including the special `verify_finding` and `decision_chain` extra fields in `input`.
- `POST /result` handler flow: (1) validate body via Pydantic, (2) check `unit_id` exists — 404 if not, (3) check idempotency — return existing result if already accepted, (4) call `ValidationLayer.validate_result()`, (5) if accepted, call `FindingsStore.store_finding()`, (6) call `WorkUnitGenerator.mark_unit_complete()`, (7) return `AcceptanceResponse`.
- Authentication (API key header) is POST-MVP. For MVP, all endpoints are open. Add a `# POST-MVP: add X-SEFI-API-Key auth here` comment in the route handlers.
- Rate limiting is POST-MVP. Add a corresponding comment stub.
- `version` in health response should come from `pyproject.toml` via `importlib.metadata.version("sefi")`.
