# US-006: Work Unit Generator — decision_chain

**Status:** tested
**Model:** sonnet
**Component:** 2 (Work Unit Generator)
**Depends On:** US-001, US-003, US-005
**Traces To:** FR-013, FR-017, FR-018, FR-019

## Description

Extends `src/sefi/generator/units.py` with the `decision_chain` generator. Each `decision_chain` unit batches 20–50 document references from the same 30-day time window, drawn from the ingested relationships and persons data. The story reuses the `WorkUnit` dataclass and assignment tracking machinery established in US-005.

## Files to Create / Modify

- `src/sefi/generator/units.py` — extend `WorkUnitGenerator` with `decision_chain` branch in `generate_unit()`; add time-window selection logic
- `tests/unit/test_units_decision_chain.py` — unit tests for batch size bounds (20–50), time-window constraint, field completeness, and assignment deduplication

## Acceptance Criteria

- [ ] A generated `decision_chain` unit contains all required `WorkUnit` fields (FR-017)
- [ ] `input.data` contains between 20 and 50 document references (FR-013)
- [ ] All document references in a single unit come from within the same 30-day time window; this is verifiable from the document metadata included in the unit (FR-013)
- [ ] `input` includes `time_window_start` and `time_window_end` as ISO 8601 date strings, with `time_window_end` within 30 days of `time_window_start` (AC-001)
- [ ] `type` field is exactly `"decision_chain"` (FR-013)
- [ ] `path=3`, `difficulty="high"`, `scaling="multiplying"`, `optimal_batch="20-50 docs (same 30-day period)"` per the Work Unit Types Reference table (FR-017)
- [ ] The same `unit_id` is never assigned to two workers simultaneously (FR-018)
- [ ] After `mark_unit_complete(unit_id)`, the decision_chain unit does not reappear in `generate_unit()` (FR-019)
- [ ] No generated unit references DS10 content or image/video files (EC-002 — inherited from units.py)
- [ ] All new code includes type annotations and docstrings (NFR-002, NFR-008)

## Notes

- Time-window selection: group documents from `knowledge_graph_relationships.json` by their `date` field; bucket into 30-day windows; select a window that has at least 20 unassigned documents. If no window meets the minimum, `generate_unit()` raises `NoAvailableUnitsError`.
- Document reference format per AC-001: each entry in `input.data` is a dict with at minimum `efta_number` (EFTA format) and `url` (DOJ PDF URL).
- `constraints` dict: `{"max_output_tokens": 8000, "pii_filter": True, "requires_quorum": True}` (decision_chain is high-stakes, quorum required per the ethical framework).
- The `generate_unit(unit_type: str)` dispatch pattern: use `match unit_type:` (Python 3.10 structural match) to route to the appropriate private method.
- Keep the time-window bucketing logic in a private method `_select_time_window()` for testability.
